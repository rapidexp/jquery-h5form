// jQuery.h5form 2.8.0 by Author: Yoshiyuki Mikome http://www.rapidexp.com/h5form
(function($){$.fn.h5form=function(options){$.fn.outerHTML=function(){var obj=$(this).get(0);return obj.outerHTML||new XMLSerializer().serializeToString(obj)};var defaults={exprResponse:".h5form-response, .h5form-reversed",exprBehind:".h5fom-behind",colorErr:"mistyrose",emptyMessage:"このフィールドを入力してください。",unselectedMessage:"リスト内の項目を選択してください。",patternMessage:"必用なパターンに一致していません。",emailMessage:"メールアドレスが正しくありません。",urlMessage:"URLが正しくありません。",colorOff:"#a1a1a1",maxlengthMessage:"指定の文字数上限より # 文字多いです。",invalidMessage:"値が無効です。",minMessage:"最小値にとどきません。",maxMessage:"最大値をこえています。",addSpin:false,classSpinNumber:"h5form-spinNumber",classRange:"h5form-range",classSpinTime:"h5form-spinTime",classDatetime:"h5form-datetime",hasOptions:[],dynamicHtml:".h5form-dynamic"};var opts=$.extend({},defaults,options);var ua=window.navigator.userAgent.toLowerCase(),version=parseInt($.browser.version),chrome=parseInt(ua.replace(/.*chrome\/(\d+).*/,"$1")),isAndroid=(navigator.userAgent.search(/Android/)!=-1),test1=$("<input>").hide().appendTo($("body")).get(0),test2=$("textarea:first").get(0)||new Object(),hasCustomValidity=("setCustomValidity" in test1)&&!isAndroid,hasAppendTitle=(!!$.browser.webkit&&version>=533)&&!isAndroid,hasAutofocus=("autofocus" in test1),hasRequired=("required" in test1)&&!isAndroid,hasPattern=("pattern" in test1)&&!isAndroid,hasEmail=hasUrl=hasCustomValidity&&hasPattern&&!isAndroid,hasPlaceholder=("placeholder" in test1),hasNumber=hasSpin=hasRange=("step" in test1)&&("min" in test1)&&!isAndroid&&!$.browser.mozilla,hasDateTime=(!!$.browser.opera&&version>9)&&!isAndroid,hasDate=hasDateTime||chrome>21,hasTime=hasDateTime||chrome>22,hasMaxlength=("maxLength" in test2),hasFormAttr=("form" in test1)&&("formAction" in test1)&&!isAndroid,hasBugButton=($.browser.msie&&version<9);hasBugEnter=($.browser.msie&&version<9)||isAndroid;for(i in opts.hasOptions){eval(opts.hasOptions[i]+"=true;")}$("input:last").remove();var validatable=":input:enabled:not(:button, :submit, :radio, :checkbox)";$(validatable).click(function(){$(this).siblings(opts.exprResponse).remove();$(opts.exprBehind).removeAttr("disabled")});$(opts.exprResponse).live("click",function(){$(this).remove()});return this.each(function(){var form=$(this),elmAutofocus,elmPlaceholder=new Array(),validatableElements=form.find(validatable),novalidate=!!form.outerHTML().match(/^[^>]+ novalidate/);$.fn.setCustomValidity=function(message){if(novalidate){message=null}var ui=$(this);if(ui.is(validatable)){if(!hasAppendTitle&&message&&(title=ui.getAttr("title"))){message+="\n"+title}if(hasCustomValidity){ui.get(0).setCustomValidity(message)}else{if(message){ui.data("customValidity",message.replace(/\n/,"<br />")).css("backgroundColor",opts.colorErr)}else{ui.removeData("customValidity").css("backgroundColor","")}}}return ui};$.fn.spin=function(isDown){var ui=$(this),isNumber=(ui.getAttr("type").toLowerCase()=="number"),min=attr2num(ui,"min",(isNumber)?"":0),max=attr2num(ui,"max",(isNumber)?"":86400),step=attr2num(ui,"step",(isNumber)?1:60),base=(isNumber)?min:0,val=(isNumber)?Number(ui.val()):str2sec(ui.val(),true);val=val-((val-base)%step)+step*((isDown)?-1:1);if(max!=""&&val>max){val=max}if(min!=""&&val<min){val=min}ui.val((isNumber)?val:sec2str(val,step%60,true));return ui};$.fn.getAttr=function(name){var attr=$(this).attr(name);return(attr==undefined)?"":attr};$.fn.initControl=function(){return this.each(function(){var ui=$(this),type=ui.getAttr("type").toLowerCase();if(!hasAutofocus&&!elmAutofocus&&ui.getAttr("autofocus")){elmAutofocus=ui}var placeholder=ui.getAttr("placeholder");if(!hasPlaceholder&&placeholder&&type!="password"){elmPlaceholder.push(ui);var evFocus=(function(){if(ui.val()==placeholder){ui.attr("value","").css("color","")}});ui.unbind("focus",evFocus).focus(evFocus);var evBlur=(function(){if(ui.val()==""||ui.val()==placeholder){ui.val(placeholder).css("color",opts.colorOff)}});ui.unbind("blur",evBlur).blur(evBlur).blur()}if((!hasSpin&&type=="number")||(!hasTime&&type=="time")||false){var className,allow;switch(type){case"number":className=opts.classSpinNumber;allow=[8,9,35,36,37,39,46,190];break;default:className=opts.classSpinTime;allow=[8,9,35,36,37,39,46,59,186,190];break}var evKeydown=(function(ev){var cc=ev.charCode||ev.keyCode;if(cc==38){ui.spin(0)}if(cc==40){ui.spin(1)}if(($.inArray(cc,allow)>=0)||(cc>=48&&cc<=57)){return true}return false});ui.unbind("keydown",evKeydown).keydown(evKeydown);if(opts.addSpin){ui.after('<span class="'+className+'"><button type="button">&and;</button><button type="button">&or;</button></span>');ui.next().children().click(function(){ui.spin(ui.next().children().index($(this))).change()})}}if(!hasDate&&(type=="date")&&("datepicker" in ui)){var option={dateFormat:"yy-mm-dd"};option.minDate=ui.getAttr("min");option.maxDate=ui.getAttr("max");ui.datepicker(option)}if(!hasRange&&(type=="range")&&("slider" in ui)){var min=attr2num(ui,"min",0),max=attr2num(ui,"max",100),step=attr2num(ui,"step",1),val=attr2num(ui,"val",(min+max)/2-((min+max)/2%step));ui.hide().after('<span class="'+opts.classRange+'"><div></div></span>').val(val);ui.next().children().slider({min:min,max:max,step:step,value:val,change:function(ev,sl){ui.val($(this).slider("value"))}})}if(!hasMaxlength&&ui.is("textarea")&&(maxlength=ui.getAttr("maxlength"))){var evKeypress=(function(ev){var cc=ev.charCode||ev.keyCode;if(($.inArray(cc,[8,9,37,39,46])<0)&&(this.value.length>=maxlength)){return false}return true});ui.unbind("keypress",evKeypress).keypress(evKeypress)}if(!hasDateTime&&(type=="datetime"||type=="datetime-local")){if(!ui.next().hasClass(opts.classDatetime)){var val=getLocalDatetime(ui.val()),min=getLocalDatetime(ui.getAttr("min")),max=getLocalDatetime(ui.getAttr("max")),tz=(type=="datetime")?'<span class="h5form-timezone">'+getTZ()+"</span>":"";ui.hide().after('<span class="'+opts.classDatetime+'"><input type="date" value="'+val[0]+'" min="'+min[0]+'" max="'+max[0]+'" size="'+ui.getAttr("size")+'" class="'+ui.getAttr("class")+'" title="'+ui.getAttr("title")+'"><input type="time" value="'+val[1]+'" step="'+attr2num(ui,"step",60)+'" size="'+ui.getAttr("size")+'" class="'+ui.getAttr("class")+'" title="'+ui.getAttr("title")+'">'+tz+"</span>");if(ui.getAttr("required")){ui.removeAttr("required");ui.next().children().attr("required","required").initControl()}else{ui.next().children().initControl()}}}var evChange=(function(){var isNecessary=false,isEmpty=((ui.val()=="")||(placeholder&&ui.val()==placeholder)||false);ui.setCustomValidity(null);if(hasBugEnter&&!ui.is("select, textarea, button")){var evKeypress2=(function(ev){var cc=ev.charCode||ev.keyCode;if(cc==13){form.find("input:submit, button:submit").eq(0).click();return false}return true});ui.unbind("keypress",evKeypress2).keypress(evKeypress2);isNecessary=true}if(!hasRequired&&ui.getAttr("required")){isNecessary=true;if(isEmpty){ui.setCustomValidity((ui.is("select"))?opts.unselectedMessage:opts.emptyMessage);return true}}if(!hasPattern&&(pattern=ui.getAttr("pattern"))){isNecessary=true;if(!isEmpty&&validateRe(ui,"^("+pattern.replace(/^\^?(.*)\$?$/,"$1")+")$")){ui.setCustomValidity(opts.patternMessage);return true}}if(!hasEmail&&type=="email"){isNecessary=true;if(!isEmpty&&validateRe(ui,"[\\w-\\.]{3,}@([\\w-]{2,}\\.)*([\\w-]{2,}\\.)[\\w-]{2,4}","i")){ui.setCustomValidity(opts.emailMessage);return true}}if(!hasUrl&&type=="url"){isNecessary=true;if(!isEmpty&&validateRe(ui,"[\\w-\\.]{3,}:\\/\\/([\\w-]{2,}\\.)*([\\w-]{2,}\\.)[\\w-]{2,4}","i")){ui.setCustomValidity(opts.urlMessage);return true}}if(!hasMaxlength&&ui.is("textarea")&&ui.getAttr("maxlength")){isNecessary=true;if(over=validateMaxlength(ui)){ui.setCustomValidity(opts.maxlengthMessage.replace(/#/,over));return true}}if((!hasNumber&&type=="number")||(!hasDateTime&&(type=="date"||type=="time"))||false){isNecessary=true;var ui0=ui,type0=type,ui2=ui;if(ui.parent().hasClass(opts.classDatetime)){ui0=ui.parent().prev();type0=ui0.getAttr("type").toLowerCase();ui2=ui.parent().children("input");ui2.setCustomValidity("");var i=ui2.index(ui),date=ui2.eq(0).val(),time=ui2.eq(1).val();if(date!=""||time!=""){if(date==""||time==""){var min=getLocalDatetime(ui0.getAttr("min"),true);if(i==0&&date!=""&&time==""){ui2.eq(1).val(min[1])}if(i==1&&time!=""&&date==""){ui2.eq(0).val(min[0])}date=ui2.eq(0).val(),time=ui2.eq(1).val()}var val=$.trim(date+"T"+time);if(type0=="datetime-local"){ui0.val(val)}else{var dt=getUTCDatetime(val);ui0.val(dt[0]+"T"+dt[1])}}else{ui0.val("")}}var pattern="^-?\\d+\\.?\\d*$",min=0,step=1;switch(type0){case"date":pattern="^\\d+-\\d+-\\d+$";min="1970-01-01";step=1;break;case"time":pattern="^\\d+:\\d+:?\\d*\\.?\\d*$";min="00:00";step=60;break;case"datetime":pattern="^\\d+-\\d+-\\d+T\\d+:\\d+:?\\d*\\.?\\d*Z$";min="1970-01-01T00:00";step=60;break;case"datetime-local":pattern="^\\d+-\\d+-\\d+T\\d+:\\d+:?\\d*\\.?\\d*$";min="1970-01-01T00:00";step=60;break}if(validateRe(ui0,pattern)||(validateStep(ui0,min,step))){ui2.setCustomValidity(opts.invalidMessage);return true}if(validateMin(ui0)){ui2.setCustomValidity(opts.minMessage.replace(/#/,ui0.getAttr("min")));return true}if(validateMax(ui0)){ui2.setCustomValidity(opts.maxMessage.replace(/#/,ui0.getAttr("max")));return true}}return isNecessary});if(evChange()){ui.unbind("change",evChange).change(evChange)}})};validatableElements.initControl();if(elmAutofocus){elmAutofocus.focus().select()}form.find("input:submit, input:image, input:button, button:submit").click(function(ev){if(ev.result==false){return false}var ui=$(this);if(!hasFormAttr){if(attr=ui.getAttr("formaction")){form.attr("action",attr)}if(attr=ui.getAttr("formeenctype")){form.attr("enctype",attr)}if(attr=ui.getAttr("formmethod")){form.attr("method",attr)}if(attr=ui.getAttr("formtarget")){form.attr("target",attr)}if(null!=ui.attr("formnovalidate")){form.attr("novalidate","novalidate");validatableElements.each(function(){$(this).setCustomValidity("")})}}form.find(opts.dynamicHtml).initControl();if(!hasCustomValidity){var result=true;validatableElements.each(function(){if(message=$(this).data("customValidity")){err=$(this);if(!err.prev().is(opts.exprResponse)){var m=opts.exprResponse.match(/^\.([^, ]+),? *\.?([^, ]*)/),name=($(window).width()-err.offset().left<300&&!!m[2])?m[2]:m[1];err.before('<span class="'+name+'"></span>');$(opts.exprBehind).attr("disabled","disabled")}err.prev().html("<p>"+message.replace(/\n/,"<br/>")+"</p>");err.focus().select();return(result=false)}});return result}if(!hasPlaceholder){for(var i in elmPlaceholder){if(i!=undefined){var elm=elmPlaceholder[i];if(elm.val()==elm.getAttr("placeholder")){elm.val("")}}}}if(hasBugButton){$('<input type="hidden" name="'+ui.getAttr("name")+'" value="'+ui.val()+'">').appendTo(form);form.find("button, input:submit").attr("name","");if(ui.is("button")){form.find("input:submit").remove()}}})});function validateRe(item,pattern,flags){re=new RegExp(pattern,flags);return((item.val()!="")&&item.val().search(re))}function validateMaxlength(item){var len=item.val().length,max=attr2num(item,"maxlength",0);return(len&&max&&(len>max))?len-max:0}function validateStep(item,min,step){min=(item.getAttr("type").toLowerCase().indexOf("datetime"))?attr2num(item,"min",min):attr2num(item,"",min);step=attr2num(item,"step",step);var val=attr2num(item,"val","");return((val!="")&&((val-min)%step))}function validateMin(item){var val=attr2num(item,"val",""),min=attr2num(item,"min","");return((val!="")&&(min!="")&&(val<min))}function validateMax(item){var val=attr2num(item,"val",""),max=attr2num(item,"max","");return((val!="")&&(max!="")&&(val>max))}function attr2num(item,name,def){var val=(name)?((name=="val")?item.val():item.getAttr(name)):def;if(val==undefined||val==""){val=""+def}if(val.match(/\d+-\d+-\d+[ T]\d+:\d/)){return Date.parse(utc2js(val))/(1000)}if(val.match(/\d+-\d+-\d+/)){return Date.parse(utc2js(val))/(1000*60*60*24)}if(val.match(/\d+:\d/)){return str2sec(val,true)}return Number(val)}function str2sec(str,gmt){if(str.search(/\d+:\d+/)){str="00:00"}if(gmt){str+=" GMT"}return Date.parse("1970/1/1 "+str)/1000}function sec2str(time,sec,gmt){var date=new Date(time*1000);ret=(gmt)?date.toUTCString():toString();return ret.replace((sec)?/.* (\d+:\d+:\d+).*$/:/.* (\d+:\d+).*$/,"$1")}function getLocalDatetime(val,NullIsToday){if(!val&&!NullIsToday){return new Array("","")}var dt=(!val)?new Date():new Date(utc2js(val)),date=dt.getFullYear()+"-"+(dt.getMonth()+1)+"-"+dt.getDate();date=date.replace(/\b(\d)\b/g,"0$1");var time=(val)?dt.toString().replace(/.* (\d+:\d+:\d+).*$/,"$1"):"12:00";return new Array(date,time)}function getUTCDatetime(val){var dt=new Date(utc2js(val)),date=dt.getUTCFullYear()+"-"+(dt.getUTCMonth()+1)+"-"+dt.getUTCDate();date=date.replace(/\b(\d)\b/g,"0$1");var time=dt.toUTCString().replace(/.* (\d+:\d+:\d+).*$/,"$1Z");return new Array(date,time)}function utc2js(val){return val.replace(/-/g,"/").replace(/T/," ").replace(/Z/," GMT").replace(/([+-])(\d+):(\d+)/," GMT$1$2$3")}function getTZ(){var dt=new Date(),min=-1*dt.getTimezoneOffset();if(min){var ret=min/60+":"+min%60;return ret.replace(/\b(\d)\b/g,"0$1").replace(/^(\d)/,"+$1")}else{return"UTC"}}}})(jQuery);